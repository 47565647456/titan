@page "/rate-limiting"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Orleans
@using Titan.Abstractions.Grains
@using Titan.Abstractions.Models
@attribute [Authorize(Policy = "SuperAdmin")]
@inject IClusterClient ClusterClient
@inject ILogger<RateLimiting> Logger

<PageTitle>Rate Limiting - Titan Admin</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>‚ö° Rate Limiting</h1>
        <p class="subtitle">Configure API throttling policies</p>
    </div>

    @if (IsLoading)
    {
        <div class="loading">Loading configuration...</div>
    }
    else if (Config != null)
    {
        <!-- Global Toggle -->
        <div class="config-card">
            <div class="config-header">
                <h2>Global Settings</h2>
                <div class="toggle-switch @(Config.Enabled ? "enabled" : "disabled")" @onclick="ToggleEnabledAsync">
                    <span class="toggle-label">@(Config.Enabled ? "Enabled" : "Disabled")</span>
                    <div class="toggle-track">
                        <div class="toggle-thumb"></div>
                    </div>
                </div>
            </div>
            <p class="config-description">
                @if (Config.Enabled)
                {
                    <span class="status-ok">‚úÖ Rate limiting is active. Requests will be throttled according to policies.</span>
                }
                else
                {
                    <span class="status-warning">‚ö†Ô∏è Rate limiting is disabled. All requests will be allowed without limits.</span>
                }
            </p>
            <p class="text-muted">Default Policy: <strong>@Config.DefaultPolicyName</strong></p>
        </div>

        <!-- Policies Section -->
        <div class="section-header">
            <h2>üìã Policies</h2>
            <button class="btn btn-primary" @onclick="ShowCreatePolicyDialog">
                ‚ûï Add Policy
            </button>
        </div>

        @if (Config.Policies.Count == 0)
        {
            <div class="empty-state">
                <p>No policies configured.</p>
            </div>
        }
        else
        {
            <div class="cards-grid">
                @foreach (var policy in Config.Policies)
                {
                    <div class="policy-card @(policy.Name == Config.DefaultPolicyName ? "default-policy" : "")">
                        <div class="policy-header">
                            <h3>@policy.Name</h3>
                            @if (policy.Name == Config.DefaultPolicyName)
                            {
                                <span class="badge badge-default">Default</span>
                            }
                        </div>
                        <div class="policy-rules">
                            @foreach (var rule in policy.Rules)
                            {
                                <div class="rule-item">
                                    <span class="rule-limits">@rule.MaxHits requests</span>
                                    <span class="rule-period">per @FormatDuration(rule.PeriodSeconds)</span>
                                    <span class="rule-timeout">@FormatDuration(rule.TimeoutSeconds) timeout</span>
                                </div>
                            }
                        </div>
                        <div class="policy-actions">
                            <button class="btn btn-small btn-secondary" @onclick="() => ShowEditPolicyDialog(policy)">Edit</button>
                            @if (policy.Name != Config.DefaultPolicyName)
                            {
                                <button class="btn btn-small btn-secondary" @onclick="() => SetDefaultPolicyAsync(policy.Name)">Set Default</button>
                            }
                            <button class="btn btn-small btn-danger" @onclick="() => ShowDeletePolicyDialog(policy)" disabled="@(policy.Name == Config.DefaultPolicyName)">Delete</button>
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Endpoint Mappings Section -->
        <div class="section-header">
            <h2>üîó Endpoint Mappings</h2>
            <button class="btn btn-primary" @onclick="ShowCreateMappingDialog">
                ‚ûï Add Mapping
            </button>
        </div>

        @if (Config.EndpointMappings.Count == 0)
        {
            <div class="empty-state">
                <p>No endpoint mappings configured. All endpoints will use the default policy.</p>
            </div>
        }
        else
        {
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Pattern</th>
                            <th>Policy</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var mapping in Config.EndpointMappings)
                        {
                            <tr>
                                <td><code>@mapping.Pattern</code></td>
                                <td>@mapping.PolicyName</td>
                                <td>
                                    <button class="btn btn-small btn-danger" @onclick="() => RemoveMappingAsync(mapping.Pattern)">Remove</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        <!-- Reset Button -->
        <div class="actions-bar">
            <button class="btn btn-danger" @onclick="ShowResetDialog">
                üîÑ Reset to Defaults
            </button>
        </div>
    }

    <!-- Create/Edit Policy Dialog -->
    @if (ShowPolicyDialog)
    {
        <div class="modal-overlay" @onclick="ClosePolicyDialog">
            <div class="modal-content modal-large" @onclick:stopPropagation="true">
                <h2>@(IsEditingPolicy ? "Edit Policy" : "Create Policy")</h2>
                
                <div class="form-group">
                    <label>Policy Name</label>
                    <input type="text" @bind="CurrentPolicyEdit!.Name" class="form-control" disabled="@IsEditingPolicy" />
                </div>
                
                <div class="form-group">
                    <label>Rules</label>
                    <p class="text-muted">Format: MaxHits per PeriodSeconds with TimeoutSeconds penalty</p>
                    
                    @for (int i = 0; i < CurrentPolicyEdit!.Rules.Count; i++)
                    {
                        var index = i;
                        <div class="rule-editor">
                            <input type="number" @bind="CurrentPolicyEdit.Rules[index].MaxHits" class="form-control form-inline" placeholder="Max Hits" min="1" />
                            <span>requests per</span>
                            <input type="number" @bind="CurrentPolicyEdit.Rules[index].PeriodSeconds" class="form-control form-inline" placeholder="Period (s)" min="1" />
                            <span>seconds, timeout</span>
                            <input type="number" @bind="CurrentPolicyEdit.Rules[index].TimeoutSeconds" class="form-control form-inline" placeholder="Timeout (s)" min="1" />
                            <span>seconds</span>
                            <button type="button" class="btn btn-small btn-danger" @onclick="() => RemoveRule(index)">‚úï</button>
                        </div>
                    }
                    
                    <button type="button" class="btn btn-small btn-secondary" @onclick="AddRule">‚ûï Add Rule</button>
                </div>
                
                @if (!string.IsNullOrEmpty(ErrorMessage))
                {
                    <div class="alert alert-danger">@ErrorMessage</div>
                }
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" @onclick="ClosePolicyDialog">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SavePolicyAsync" disabled="@IsSaving">
                        @(IsSaving ? "Saving..." : "Save")
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Create Mapping Dialog -->
    @if (ShowMappingDialog)
    {
        <div class="modal-overlay" @onclick="CloseMappingDialog">
            <div class="modal-content" @onclick:stopPropagation="true">
                <h2>Add Endpoint Mapping</h2>
                
                <div class="form-group">
                    <label>Pattern</label>
                    <input type="text" @bind="MappingPattern" class="form-control" placeholder="/api/auth/* or TradeHub.*" />
                    <p class="text-muted">Use * as wildcard. HTTP: /api/path/*, SignalR: HubName.*</p>
                </div>
                
                <div class="form-group">
                    <label>Policy</label>
                    <select @bind="MappingPolicyName" class="form-control">
                        @foreach (var policy in Config?.Policies ?? [])
                        {
                            <option value="@policy.Name">@policy.Name</option>
                        }
                    </select>
                </div>
                
                @if (!string.IsNullOrEmpty(ErrorMessage))
                {
                    <div class="alert alert-danger">@ErrorMessage</div>
                }
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" @onclick="CloseMappingDialog">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveMappingAsync" disabled="@IsSaving">
                        @(IsSaving ? "Saving..." : "Save")
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Delete Policy Confirm -->
    @if (ShowDeletePolicyConfirm)
    {
        <div class="modal-overlay" @onclick="CloseDeletePolicyDialog">
            <div class="modal-content modal-small" @onclick:stopPropagation="true">
                <h2>‚ö†Ô∏è Delete Policy</h2>
                <p>Are you sure you want to delete <strong>@DeletePolicyTarget?.Name</strong>?</p>
                <p class="text-muted">Endpoints using this policy will fall back to the default.</p>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDeletePolicyDialog">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="DeletePolicyAsync" disabled="@IsDeleting">
                        @(IsDeleting ? "Deleting..." : "Delete")
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Reset Confirm -->
    @if (ShowResetConfirm)
    {
        <div class="modal-overlay" @onclick="CloseResetDialog">
            <div class="modal-content modal-small" @onclick:stopPropagation="true">
                <h2>üîÑ Reset to Defaults</h2>
                <p>This will remove all custom policies and mappings.</p>
                <p class="text-muted">The configuration will be reset to the values from appsettings.json.</p>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" @onclick="CloseResetDialog">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="ResetToDefaultsAsync" disabled="@IsResetting">
                        @(IsResetting ? "Resetting..." : "Reset")
                    </button>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .config-card {
        background: var(--titan-surface);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid var(--titan-border);
    }
    
    .config-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .config-header h2 {
        margin: 0;
    }
    
    .toggle-switch {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        user-select: none;
    }
    
    .toggle-track {
        width: 48px;
        height: 26px;
        background: var(--titan-surface-light);
        border-radius: 13px;
        position: relative;
        transition: background 0.2s;
    }
    
    .toggle-switch.enabled .toggle-track {
        background: var(--titan-success);
    }
    
    .toggle-thumb {
        width: 22px;
        height: 22px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 2px;
        left: 2px;
        transition: left 0.2s;
    }
    
    .toggle-switch.enabled .toggle-thumb {
        left: 24px;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 2rem 0 1rem;
    }
    
    .section-header h2 {
        margin: 0;
    }
    
    .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .policy-card {
        background: var(--titan-surface);
        border-radius: 0.75rem;
        padding: 1.25rem;
        border: 1px solid var(--titan-border);
    }
    
    .policy-card.default-policy {
        border-color: var(--titan-primary);
    }
    
    .policy-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .policy-header h3 {
        margin: 0;
    }
    
    .badge-default {
        background: var(--titan-primary);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
    }
    
    .policy-rules {
        margin-bottom: 1rem;
    }
    
    .rule-item {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--titan-surface-light);
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }
    
    .rule-limits {
        font-weight: 600;
        color: var(--titan-primary);
    }
    
    .rule-timeout {
        color: var(--titan-accent);
    }
    
    .policy-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .rule-editor {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        background: var(--titan-surface-light);
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .form-inline {
        width: 80px;
    }
    
    .modal-large {
        max-width: 700px;
    }
    
    .status-warning {
        color: var(--titan-accent);
    }
</style>

@code {
    private RateLimitingConfiguration? Config { get; set; }
    private bool IsLoading { get; set; } = true;
    private bool ShowPolicyDialog { get; set; }
    private bool ShowMappingDialog { get; set; }
    private bool ShowDeletePolicyConfirm { get; set; }
    private bool ShowResetConfirm { get; set; }
    private bool IsEditingPolicy { get; set; }
    private bool IsSaving { get; set; }
    private bool IsDeleting { get; set; }
    private bool IsResetting { get; set; }
    private string? ErrorMessage { get; set; }
    private PolicyEditModel? CurrentPolicyEdit { get; set; }
    private RateLimitPolicy? DeletePolicyTarget { get; set; }
    private string MappingPattern { get; set; } = "";
    private string MappingPolicyName { get; set; } = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadConfigAsync();
    }

    private async Task LoadConfigAsync()
    {
        IsLoading = true;
        try
        {
            var grain = ClusterClient.GetGrain<IRateLimitConfigGrain>("default");
            Config = await grain.GetConfigurationAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load rate limit configuration");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task ToggleEnabledAsync()
    {
        if (Config == null) return;
        
        try
        {
            var grain = ClusterClient.GetGrain<IRateLimitConfigGrain>("default");
            await grain.SetEnabledAsync(!Config.Enabled);
            await LoadConfigAsync();
            Logger.LogInformation("Rate limiting {Status}", Config.Enabled ? "enabled" : "disabled");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to toggle rate limiting");
        }
    }

    private void ShowCreatePolicyDialog()
    {
        CurrentPolicyEdit = new PolicyEditModel { Name = "", Rules = [new RuleEditModel()] };
        IsEditingPolicy = false;
        ErrorMessage = null;
        ShowPolicyDialog = true;
    }

    private void ShowEditPolicyDialog(RateLimitPolicy policy)
    {
        CurrentPolicyEdit = new PolicyEditModel
        {
            Name = policy.Name,
            Rules = policy.Rules.Select(r => new RuleEditModel
            {
                MaxHits = r.MaxHits,
                PeriodSeconds = r.PeriodSeconds,
                TimeoutSeconds = r.TimeoutSeconds
            }).ToList()
        };
        IsEditingPolicy = true;
        ErrorMessage = null;
        ShowPolicyDialog = true;
    }

    private void ClosePolicyDialog()
    {
        ShowPolicyDialog = false;
        CurrentPolicyEdit = null;
    }

    private void AddRule()
    {
        CurrentPolicyEdit?.Rules.Add(new RuleEditModel());
    }

    private void RemoveRule(int index)
    {
        if (CurrentPolicyEdit?.Rules.Count > 1)
        {
            CurrentPolicyEdit.Rules.RemoveAt(index);
        }
    }

    private async Task SavePolicyAsync()
    {
        if (CurrentPolicyEdit == null || string.IsNullOrWhiteSpace(CurrentPolicyEdit.Name)) return;
        if (CurrentPolicyEdit.Rules.Count == 0)
        {
            ErrorMessage = "At least one rule is required";
            return;
        }

        IsSaving = true;
        ErrorMessage = null;

        try
        {
            var policy = new RateLimitPolicy(
                CurrentPolicyEdit.Name,
                CurrentPolicyEdit.Rules.Select(r => new RateLimitRule(r.MaxHits, r.PeriodSeconds, r.TimeoutSeconds)).ToList()
            );

            var grain = ClusterClient.GetGrain<IRateLimitConfigGrain>("default");
            await grain.UpsertPolicyAsync(policy);
            
            Logger.LogInformation("Saved rate limit policy: {PolicyName}", policy.Name);
            ClosePolicyDialog();
            await LoadConfigAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save policy");
            ErrorMessage = ex.Message;
        }
        finally
        {
            IsSaving = false;
        }
    }

    private void ShowDeletePolicyDialog(RateLimitPolicy policy)
    {
        DeletePolicyTarget = policy;
        ShowDeletePolicyConfirm = true;
    }

    private void CloseDeletePolicyDialog()
    {
        ShowDeletePolicyConfirm = false;
        DeletePolicyTarget = null;
    }

    private async Task DeletePolicyAsync()
    {
        if (DeletePolicyTarget == null) return;

        IsDeleting = true;

        try
        {
            var grain = ClusterClient.GetGrain<IRateLimitConfigGrain>("default");
            await grain.RemovePolicyAsync(DeletePolicyTarget.Name);
            
            Logger.LogInformation("Deleted rate limit policy: {PolicyName}", DeletePolicyTarget.Name);
            CloseDeletePolicyDialog();
            await LoadConfigAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to delete policy");
        }
        finally
        {
            IsDeleting = false;
        }
    }

    private async Task SetDefaultPolicyAsync(string policyName)
    {
        try
        {
            var grain = ClusterClient.GetGrain<IRateLimitConfigGrain>("default");
            await grain.SetDefaultPolicyAsync(policyName);
            
            Logger.LogInformation("Set default policy: {PolicyName}", policyName);
            await LoadConfigAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to set default policy");
        }
    }

    private void ShowCreateMappingDialog()
    {
        MappingPattern = "";
        MappingPolicyName = Config?.Policies.FirstOrDefault()?.Name ?? "";
        ErrorMessage = null;
        ShowMappingDialog = true;
    }

    private void CloseMappingDialog()
    {
        ShowMappingDialog = false;
    }

    private async Task SaveMappingAsync()
    {
        if (string.IsNullOrWhiteSpace(MappingPattern) || string.IsNullOrWhiteSpace(MappingPolicyName))
        {
            ErrorMessage = "Pattern and policy are required";
            return;
        }

        IsSaving = true;
        ErrorMessage = null;

        try
        {
            var mapping = new EndpointRateLimitConfig(MappingPattern, MappingPolicyName);
            var grain = ClusterClient.GetGrain<IRateLimitConfigGrain>("default");
            await grain.AddEndpointMappingAsync(mapping);
            
            Logger.LogInformation("Added endpoint mapping: {Pattern} -> {PolicyName}", MappingPattern, MappingPolicyName);
            CloseMappingDialog();
            await LoadConfigAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save mapping");
            ErrorMessage = ex.Message;
        }
        finally
        {
            IsSaving = false;
        }
    }

    private async Task RemoveMappingAsync(string pattern)
    {
        try
        {
            var grain = ClusterClient.GetGrain<IRateLimitConfigGrain>("default");
            await grain.RemoveEndpointMappingAsync(pattern);
            
            Logger.LogInformation("Removed endpoint mapping: {Pattern}", pattern);
            await LoadConfigAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to remove mapping");
        }
    }

    private void ShowResetDialog()
    {
        ShowResetConfirm = true;
    }

    private void CloseResetDialog()
    {
        ShowResetConfirm = false;
    }

    private async Task ResetToDefaultsAsync()
    {
        IsResetting = true;

        try
        {
            // Reset via grain directly - clears all configuration
            // The API's RateLimitConfigInitializer will repopulate defaults on next startup
            var grain = ClusterClient.GetGrain<IRateLimitConfigGrain>("default");
            await grain.ResetToDefaultsAsync();

            Logger.LogInformation("Reset rate limit configuration to defaults via grain");
            CloseResetDialog();
            await LoadConfigAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to reset configuration");
        }
        finally
        {
            IsResetting = false;
        }
    }

    private static string FormatDuration(int seconds)
    {
        if (seconds >= 3600)
            return $"{seconds / 3600}h";
        if (seconds >= 60)
            return $"{seconds / 60}m";
        return $"{seconds}s";
    }

    private sealed class PolicyEditModel
    {
        public string Name { get; set; } = "";
        public List<RuleEditModel> Rules { get; set; } = new();
    }

    private sealed class RuleEditModel
    {
        public int MaxHits { get; set; } = 100;
        public int PeriodSeconds { get; set; } = 60;
        public int TimeoutSeconds { get; set; } = 300;
    }
}
